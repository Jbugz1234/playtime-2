<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI CSV Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            text-align: center;
        }

        .file-upload-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin: 20px 0;
        }

        .file-upload-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .file-upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #fileInput {
            display: none;
        }

        .file-list {
            margin-top: 20px;
            text-align: left;
        }

        .file-item {
            background: #f5f5f5;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 8px;
            display: inline-block;
            margin-right: 10px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .chart-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 1em;
        }

        /* Co-pilot Chat Interface */
        .copilot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .copilot-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        .copilot-button:hover {
            transform: scale(1.1);
        }

        .copilot-window {
            display: none;
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            flex-direction: column;
            overflow: hidden;
        }

        .copilot-window.active {
            display: flex;
        }

        .copilot-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            font-weight: bold;
            font-size: 1.2em;
        }

        .copilot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9f9f9;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .copilot-input-container {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .copilot-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .copilot-send {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .copilot-send:hover {
            background: #5568d3;
        }

        /* Flyout Panel */
        .flyout-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .flyout-overlay.active {
            display: block;
        }

        .flyout-panel {
            position: fixed;
            right: -600px;
            top: 0;
            width: 600px;
            height: 100%;
            background: white;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.3);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 30px;
        }

        .flyout-panel.active {
            right: 0;
        }

        .flyout-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #666;
        }

        .flyout-close:hover {
            color: #333;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .data-table tr:hover {
            background: #f5f5f5;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 1.2em;
        }

        .loading.active {
            display: block;
        }

        .insights-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .insight-item {
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
            border-left: 4px solid #667eea;
            border-radius: 5px;
        }

        .insight-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .view-details-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .view-details-btn:hover {
            background: #5568d3;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .copilot-window {
                width: calc(100vw - 40px);
                right: 20px;
            }

            .flyout-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ AI CSV Analytics Dashboard</h1>
            <p class="subtitle">Upload CSV files and let AI analyze, compare, and predict outcomes</p>
        </header>

        <div class="upload-section">
            <h2>Upload CSV Files</h2>
            <div class="file-upload-wrapper">
                <label for="fileInput" class="file-upload-button">
                    üìÅ Choose Files
                </label>
                <input type="file" id="fileInput" accept=".csv" multiple>
            </div>
            <div class="file-list" id="fileList"></div>
            <div class="loading" id="loading">
                <p>üîÑ Analyzing data with AI...</p>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid"></div>

        <div class="insights-section" id="insightsSection" style="display: none;">
            <h2 class="chart-title">üß† AI Insights & Predictions</h2>
            <div id="insightsContainer"></div>
        </div>

        <div class="dashboard-grid" id="dashboardGrid"></div>
    </div>

    <!-- Co-pilot Chat -->
    <div class="copilot-container">
        <button class="copilot-button" id="copilotToggle">üí¨</button>
        <div class="copilot-window" id="copilotWindow">
            <div class="copilot-header">
                AI Co-Pilot Assistant
            </div>
            <div class="copilot-messages" id="copilotMessages">
                <div class="message ai">
                    Hi! I'm your AI assistant. Upload CSV files and I'll help you analyze the data. You can ask me questions or request specific visualizations!
                </div>
            </div>
            <div class="copilot-input-container">
                <input type="text" class="copilot-input" id="copilotInput" placeholder="Ask me anything...">
                <button class="copilot-send" id="copilotSend">Send</button>
            </div>
        </div>
    </div>

    <!-- Flyout Panel -->
    <div class="flyout-overlay" id="flyoutOverlay"></div>
    <div class="flyout-panel" id="flyoutPanel">
        <button class="flyout-close" id="flyoutClose">√ó</button>
        <div id="flyoutContent"></div>
    </div>

    <script>
        // Global state
        let csvData = [];
        let charts = [];
        let allHeaders = [];
        let conversationHistory = [];

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        async function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            document.getElementById('loading').classList.add('active');
            csvData = [];
            allHeaders = [];

            const fileListDiv = document.getElementById('fileList');
            fileListDiv.innerHTML = '';

            for (let file of files) {
                await parseCSV(file);
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.textContent = `‚úì ${file.name}`;
                fileListDiv.appendChild(fileItem);
            }

            setTimeout(() => {
                analyzeData();
                document.getElementById('loading').classList.remove('active');
            }, 1000);
        }

        function parseCSV(file) {
            return new Promise((resolve) => {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        csvData.push({
                            filename: file.name,
                            data: results.data,
                            headers: results.meta.fields
                        });
                        allHeaders = [...new Set([...allHeaders, ...results.meta.fields])];
                        resolve();
                    }
                });
            });
        }

        function analyzeData() {
            if (csvData.length === 0) return;

            // Clear previous charts
            charts.forEach(chart => chart.destroy());
            charts = [];

            // Generate statistics
            generateStats();

            // Generate AI insights
            generateAIInsights();

            // Create visualizations
            createVisualizations();

            // Notify copilot
            addCopilotMessage('ai', `I've analyzed ${csvData.length} CSV file(s). Found ${allHeaders.length} unique columns. Ready to answer your questions!`);
        }

        function generateStats() {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';

            const totalRows = csvData.reduce((sum, csv) => sum + csv.data.length, 0);
            const totalFiles = csvData.length;
            const totalColumns = allHeaders.length;

            const stats = [
                { label: 'Files Analyzed', value: totalFiles },
                { label: 'Total Rows', value: totalRows },
                { label: 'Unique Columns', value: totalColumns },
                { label: 'Common Fields', value: getCommonFields().length }
            ];

            stats.forEach(stat => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <div class="stat-label">${stat.label}</div>
                    <div class="stat-value">${stat.value}</div>
                `;
                statsGrid.appendChild(card);
            });
        }

        function getCommonFields() {
            if (csvData.length === 0) return [];
            if (csvData.length === 1) return csvData[0].headers;

            return csvData[0].headers.filter(header =>
                csvData.every(csv => csv.headers.includes(header))
            );
        }

        function generateAIInsights() {
            const insightsSection = document.getElementById('insightsSection');
            const insightsContainer = document.getElementById('insightsContainer');
            insightsSection.style.display = 'block';
            insightsContainer.innerHTML = '';

            const insights = [];

            // Data quality insight
            const totalRows = csvData.reduce((sum, csv) => sum + csv.data.length, 0);
            insights.push({
                title: 'Data Quality Analysis',
                content: `Processed ${totalRows} records across ${csvData.length} file(s). Data appears ${totalRows > 100 ? 'sufficient' : 'limited'} for statistical analysis.`
            });

            // Common fields insight
            const commonFields = getCommonFields();
            if (csvData.length > 1) {
                insights.push({
                    title: 'Cross-File Comparison',
                    content: `Found ${commonFields.length} common field(s): ${commonFields.join(', ')}. These fields can be used for comparative analysis.`
                });
            }

            // Numeric fields insight
            const numericFields = findNumericFields();
            if (numericFields.length > 0) {
                const predictions = generatePredictions(numericFields);
                insights.push({
                    title: 'Predictive Analysis',
                    content: `Identified ${numericFields.length} numeric field(s) for trend analysis: ${numericFields.join(', ')}. ${predictions}`
                });
            }

            // Categorical fields insight
            const categoricalFields = findCategoricalFields();
            if (categoricalFields.length > 0) {
                insights.push({
                    title: 'Category Distribution',
                    content: `Found ${categoricalFields.length} categorical field(s): ${categoricalFields.join(', ')}. These can be used for segmentation analysis.`
                });
            }

            // Render insights
            insights.forEach(insight => {
                const insightDiv = document.createElement('div');
                insightDiv.className = 'insight-item';
                insightDiv.innerHTML = `
                    <div class="insight-title">${insight.title}</div>
                    <div>${insight.content}</div>
                `;
                insightsContainer.appendChild(insightDiv);
            });
        }

        function findNumericFields() {
            const numericFields = [];
            if (csvData.length === 0) return numericFields;

            const sampleData = csvData[0].data[0];
            for (let header of csvData[0].headers) {
                const values = csvData[0].data.map(row => row[header]).filter(v => v != null);
                const numericValues = values.filter(v => typeof v === 'number' || !isNaN(parseFloat(v)));
                if (numericValues.length > values.length * 0.7) {
                    numericFields.push(header);
                }
            }
            return numericFields;
        }

        function findCategoricalFields() {
            const categoricalFields = [];
            if (csvData.length === 0) return categoricalFields;

            for (let header of csvData[0].headers) {
                const values = csvData[0].data.map(row => row[header]).filter(v => v != null);
                const uniqueValues = new Set(values);
                if (uniqueValues.size > 1 && uniqueValues.size < values.length * 0.5) {
                    categoricalFields.push(header);
                }
            }
            return categoricalFields;
        }

        function generatePredictions(numericFields) {
            if (numericFields.length === 0) return 'No numeric trends detected.';

            const field = numericFields[0];
            const values = csvData[0].data.map(row => parseFloat(row[field])).filter(v => !isNaN(v));
            
            if (values.length < 2) return 'Insufficient data for predictions.';

            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            const trend = values[values.length - 1] > values[0] ? 'increasing' : 'decreasing';
            
            return `Average ${field}: ${avg.toFixed(2)}. Trend appears to be ${trend}.`;
        }

        function createVisualizations() {
            const dashboardGrid = document.getElementById('dashboardGrid');
            dashboardGrid.innerHTML = '';

            // Create different types of charts based on data
            const numericFields = findNumericFields();
            const categoricalFields = findCategoricalFields();

            // Bar chart for numeric comparison
            if (numericFields.length > 0) {
                createBarChart(numericFields[0]);
            }

            // Pie chart for categorical data
            if (categoricalFields.length > 0) {
                createPieChart(categoricalFields[0]);
            }

            // Line chart for trends
            if (numericFields.length > 1) {
                createLineChart(numericFields);
            }

            // Multi-file comparison if multiple files
            if (csvData.length > 1 && getCommonFields().length > 0) {
                createComparisonChart();
            }

            // Scatter plot if we have 2+ numeric fields
            if (numericFields.length >= 2) {
                createScatterPlot(numericFields[0], numericFields[1]);
            }
        }

        function createBarChart(field) {
            const container = createChartContainer(`üìä ${field} - Bar Chart`);
            const canvas = container.querySelector('canvas');
            const ctx = canvas.getContext('2d');

            const values = csvData[0].data.slice(0, 10).map(row => parseFloat(row[field]) || 0);
            const labels = csvData[0].data.slice(0, 10).map((row, i) => `Row ${i + 1}`);

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: field,
                        data: values,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            charts.push(chart);
            addViewDetailsButton(container, field, 'bar');
        }

        function createPieChart(field) {
            const container = createChartContainer(`ü•ß ${field} - Distribution`);
            const canvas = container.querySelector('canvas');
            const ctx = canvas.getContext('2d');

            const valueCounts = {};
            csvData[0].data.forEach(row => {
                const value = row[field];
                if (value) {
                    valueCounts[value] = (valueCounts[value] || 0) + 1;
                }
            });

            const labels = Object.keys(valueCounts).slice(0, 8);
            const data = labels.map(label => valueCounts[label]);

            const colors = [
                'rgba(102, 126, 234, 0.8)',
                'rgba(118, 75, 162, 0.8)',
                'rgba(237, 100, 166, 0.8)',
                'rgba(255, 154, 158, 0.8)',
                'rgba(250, 208, 196, 0.8)',
                'rgba(210, 180, 222, 0.8)',
                'rgba(155, 207, 238, 0.8)',
                'rgba(192, 235, 214, 0.8)'
            ];

            const chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: 'white'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });

            charts.push(chart);
            addViewDetailsButton(container, field, 'pie');
        }

        function createLineChart(fields) {
            const container = createChartContainer(`üìà Trend Analysis`);
            const canvas = container.querySelector('canvas');
            const ctx = canvas.getContext('2d');

            const datasets = fields.slice(0, 3).map((field, index) => {
                const values = csvData[0].data.map(row => parseFloat(row[field]) || 0);
                const colors = [
                    'rgba(102, 126, 234, 1)',
                    'rgba(118, 75, 162, 1)',
                    'rgba(237, 100, 166, 1)'
                ];

                return {
                    label: field,
                    data: values,
                    borderColor: colors[index],
                    backgroundColor: colors[index].replace('1)', '0.1)'),
                    tension: 0.4,
                    fill: true
                };
            });

            const labels = csvData[0].data.map((_, i) => i + 1);

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            charts.push(chart);
            addViewDetailsButton(container, 'trends', 'line');
        }

        function createComparisonChart() {
            const container = createChartContainer(`üîÑ Multi-File Comparison`);
            const canvas = container.querySelector('canvas');
            const ctx = canvas.getContext('2d');

            const commonFields = getCommonFields();
            const numericField = commonFields.find(field => {
                const values = csvData[0].data.map(row => row[field]);
                return values.some(v => typeof v === 'number');
            });

            if (!numericField) return;

            const datasets = csvData.map((csv, index) => {
                const avg = csv.data.reduce((sum, row) => {
                    const val = parseFloat(row[numericField]) || 0;
                    return sum + val;
                }, 0) / csv.data.length;

                const colors = [
                    'rgba(102, 126, 234, 0.8)',
                    'rgba(118, 75, 162, 0.8)',
                    'rgba(237, 100, 166, 0.8)',
                    'rgba(255, 154, 158, 0.8)'
                ];

                return {
                    label: csv.filename,
                    data: [avg],
                    backgroundColor: colors[index % colors.length]
                };
            });

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [numericField],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });

            charts.push(chart);
            addViewDetailsButton(container, 'comparison', 'comparison');
        }

        function createScatterPlot(fieldX, fieldY) {
            const container = createChartContainer(`üìç ${fieldX} vs ${fieldY}`);
            const canvas = container.querySelector('canvas');
            const ctx = canvas.getContext('2d');

            const data = csvData[0].data.map(row => ({
                x: parseFloat(row[fieldX]) || 0,
                y: parseFloat(row[fieldY]) || 0
            }));

            const chart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: `${fieldX} vs ${fieldY}`,
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: fieldX
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: fieldY
                            }
                        }
                    }
                }
            });

            charts.push(chart);
            addViewDetailsButton(container, `${fieldX}_${fieldY}`, 'scatter');
        }

        function createChartContainer(title) {
            const dashboardGrid = document.getElementById('dashboardGrid');
            const container = document.createElement('div');
            container.className = 'chart-container';
            container.innerHTML = `
                <div class="chart-title">${title}</div>
                <canvas></canvas>
            `;
            dashboardGrid.appendChild(container);
            return container;
        }

        function addViewDetailsButton(container, dataKey, chartType) {
            const button = document.createElement('button');
            button.className = 'view-details-btn';
            button.textContent = 'View Details';
            button.onclick = () => showFlyout(dataKey, chartType);
            container.appendChild(button);
        }

        function showFlyout(dataKey, chartType) {
            const flyoutOverlay = document.getElementById('flyoutOverlay');
            const flyoutPanel = document.getElementById('flyoutPanel');
            const flyoutContent = document.getElementById('flyoutContent');

            let content = `<h2>Detailed View: ${dataKey}</h2>`;

            if (chartType === 'comparison') {
                content += `<h3>File Comparison Details</h3>`;
                csvData.forEach(csv => {
                    content += `<h4>${csv.filename}</h4>`;
                    content += `<p>Rows: ${csv.data.length}</p>`;
                    content += `<p>Columns: ${csv.headers.join(', ')}</p>`;
                });
            } else {
                content += `<h3>Raw Data</h3>`;
                content += generateDataTable(dataKey);
            }

            flyoutContent.innerHTML = content;
            flyoutOverlay.classList.add('active');
            flyoutPanel.classList.add('active');
        }

        function generateDataTable(field) {
            if (csvData.length === 0) return '';

            let html = '<table class="data-table"><thead><tr>';
            
            const headers = csvData[0].headers.slice(0, 5);
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';

            csvData[0].data.slice(0, 20).forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td>${row[header] || 'N/A'}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        // Flyout close handlers
        document.getElementById('flyoutClose').addEventListener('click', closeFlyout);
        document.getElementById('flyoutOverlay').addEventListener('click', closeFlyout);

        function closeFlyout() {
            document.getElementById('flyoutOverlay').classList.remove('active');
            document.getElementById('flyoutPanel').classList.remove('active');
        }

        // Co-pilot functionality
        document.getElementById('copilotToggle').addEventListener('click', toggleCopilot);
        document.getElementById('copilotSend').addEventListener('click', sendCopilotMessage);
        document.getElementById('copilotInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendCopilotMessage();
        });

        function toggleCopilot() {
            const window = document.getElementById('copilotWindow');
            window.classList.toggle('active');
        }

        function sendCopilotMessage() {
            const input = document.getElementById('copilotInput');
            const message = input.value.trim();
            if (!message) return;

            addCopilotMessage('user', message);
            input.value = '';

            // Simulate AI response
            setTimeout(() => {
                const response = processAIQuery(message);
                addCopilotMessage('ai', response);
            }, 500);
        }

        function addCopilotMessage(type, text) {
            const messagesDiv = document.getElementById('copilotMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            conversationHistory.push({ type, text });
        }

        function processAIQuery(query) {
            const lowerQuery = query.toLowerCase();

            // Handle visualization requests
            if (lowerQuery.includes('chart') || lowerQuery.includes('graph') || lowerQuery.includes('visualize')) {
                if (lowerQuery.includes('bar')) {
                    const numericFields = findNumericFields();
                    if (numericFields.length > 0) {
                        setTimeout(() => createBarChart(numericFields[0]), 1000);
                        return `Creating a bar chart for ${numericFields[0]}...`;
                    }
                }
                if (lowerQuery.includes('pie')) {
                    const categoricalFields = findCategoricalFields();
                    if (categoricalFields.length > 0) {
                        setTimeout(() => createPieChart(categoricalFields[0]), 1000);
                        return `Creating a pie chart for ${categoricalFields[0]}...`;
                    }
                }
                return "I'll create a new visualization. Please upload data first if you haven't already.";
            }

            // Handle data summary requests
            if (lowerQuery.includes('summary') || lowerQuery.includes('overview')) {
                if (csvData.length === 0) {
                    return "No data uploaded yet. Please upload CSV files to get started.";
                }
                const totalRows = csvData.reduce((sum, csv) => sum + csv.data.length, 0);
                return `Summary: ${csvData.length} file(s) with ${totalRows} total rows and ${allHeaders.length} unique columns.`;
            }

            // Handle field/column questions
            if (lowerQuery.includes('column') || lowerQuery.includes('field')) {
                if (csvData.length === 0) {
                    return "No data uploaded yet.";
                }
                return `Available columns: ${allHeaders.join(', ')}`;
            }

            // Handle comparison questions
            if (lowerQuery.includes('compare') || lowerQuery.includes('difference')) {
                if (csvData.length < 2) {
                    return "Please upload at least 2 files to compare.";
                }
                const commonFields = getCommonFields();
                return `Common fields across files: ${commonFields.join(', ')}. I can compare these fields.`;
            }

            // Handle prediction/trend questions
            if (lowerQuery.includes('predict') || lowerQuery.includes('trend') || lowerQuery.includes('forecast')) {
                const numericFields = findNumericFields();
                if (numericFields.length === 0) {
                    return "No numeric fields found for prediction analysis.";
                }
                return generatePredictions(numericFields);
            }

            // Handle analysis requests
            if (lowerQuery.includes('analyz') || lowerQuery.includes('insight')) {
                if (csvData.length === 0) {
                    return "Please upload data first for analysis.";
                }
                setTimeout(() => {
                    analyzeData();
                }, 500);
                return "Running comprehensive analysis on your data...";
            }

            // Handle refresh/update requests
            if (lowerQuery.includes('refresh') || lowerQuery.includes('update') || lowerQuery.includes('reload')) {
                if (csvData.length > 0) {
                    setTimeout(() => analyzeData(), 500);
                    return "Refreshing dashboard with latest analysis...";
                }
                return "No data to refresh. Please upload CSV files first.";
            }

            // Default helpful response
            return "I can help you with:\n‚Ä¢ Creating charts and visualizations\n‚Ä¢ Analyzing data patterns\n‚Ä¢ Comparing multiple files\n‚Ä¢ Predicting trends\n‚Ä¢ Explaining columns and data\n\nWhat would you like to explore?";
        }

        // Initialize
        console.log('AI CSV Analytics Dashboard Ready! üöÄ');
    </script>
</body>
</html>

